---
title: "Colorado: Exploratory Data Analysis and Linear Regression"
author: "Albert Sun"
date: "9/30/2020"
output: pdf_document
---

```{r global options, echo=FALSE}
knitr::opts_chunk$set(warning=FALSE, message=FALSE, echo=FALSE)
```

```{r}
library(tidyverse)
library(patchwork)
library(janitor)
library(broom)
library(knitr)
```

# The Dataset

**Open-source:** Overall, the HB 19-1297 data set is the only statewide jail database that offers an open source ".csv" file for the public to see. Even California and Texas don't have their data published completely open source; instead, researchers are forced to scrape the data periodically from the state website. As such, we find that the HB-1297 data set to be the most friendly for public use thus far.

**Collection periods:** This dataset represents 3 collection periods in 2020, split up into quarters. Q1 was in January, Q2 was in April, Q3 was in July. A frequent periodic collection of data, like quarterly, lends the dataset to really good data analysis, because we can better see the effects of policies or huge events (hint hint COVID-19) over time.

**Columns:** The 23 columns represent variables: the quarter, the year, county jail, jail management system, etc.

**Rows:** The 2280 rows generally reflect specific jail information per each quarter; however, the reason why there are 2280 rows instead of 152 rows (the number of jails times three quarters in Colorado) is because each jail has 15 rows separated into different areas of measurement, i.e. "Number of inmates", "Sentenced", etc. 

```{r read data}
colorado <- read_csv("HB19-1297Data.csv") %>%
  clean_names()

glimpse(colorado)
```

# 1. Check Proportion Missing

Instead of leaving blank values in missing columns, the Colorado HB 19-1297 jail dataset uses the `not_available` column to annotate and comment on missingness. They add `0` to a datapoint that is missing. Thus, because we cannot use conventional functions like is.na() to detect missingness, we will take a look at the jail observations that contain missing data. 

Here are the 10 most common NA messages.

```{r}
colorado %>% 
  count(not_available) %>%
  group_by(not_available) %>%
  arrange(-n) %>%
  ungroup %>%
  slice(1:10)
```

Out of 2280 rows, there are `r 2280 - 1792` (2280-1792) rows with some sort of `not_available` message. 

This means that `r 448 / 2280 * 100`% of the data has some sort of `not_available` message to it, which is relatively low.

Most of the data exists, and almost all jails at least provide some sort of ethnicity data. Most of the data that is missing is that for specific measures as aforementioned above, a jail's JMS (Jail Management System) might not break down types of sentences by gender, race, or ethnicity. When conducting data analysis on race and gender for some particular measures, it will be a good idea to remove these rows, or at least account for them. 

# 2. Check Class

Check class of data:

```{r glimpse at the data}
glimpse(colorado)
```
Judging from the datatypes above, we will change Qtr to become a factor variable, because Qtr represents periodic stages of data collection, not a continuous value.

```{r}
colorado <- colorado %>%
  mutate(qtr = as.factor(qtr))
```

Overall, the other variables seem to have the correct data type.

# 3. Investigate Missingness

```{r}
colorado <- colorado %>% 
  mutate(isNA = !is.na(not_available)) 

colorado %>%
  count(qtr, isNA) %>%
  filter(isNA == TRUE)
```

Missingness was generally reduced throughout the three quarters of jail data collection in 2020, possibly suggesting improvements in jail collection throughout this time period.

# 4. EDA

```{r}
colorado_population <- colorado %>%
  arrange(qtr) %>%
  group_by(qtr) %>%
  summarise(total = sum(total)) 

colorado_population %>%
  ggplot(aes(x = qtr, y = total)) + 
  geom_point() + 
  labs(x = "Quarter",
       y = "Total amount of people incarcerated in jail") + 
  ggtitle("Colorado jail population has reduced during COVID-19")
```
As you can see, Colorado jail population has significantly reduced during COVID-19.

```{r}
colorado %>%
  count(jms) %>%
  arrange(-n) %>%
  mutate(n = n / 5) %>%
  slice(1:8) %>%
  ggplot(aes(x = reorder(jms, -n), y = n)) + 
  geom_bar(stat = "identity") + 
  labs(x = "Jail Management System",
       y = "Count",
       title = "Top 8 utilized jail management systems in Colorado")
```

```{r Jail Population Distribution}
# facet version

colorado_dist <- colorado %>%
  group_by(county, qtr) %>%
  summarise(total = sum(total))

colorado_dist %>%
  ggplot(aes(x = total)) + 
  geom_histogram(bins = 50) + 
  facet_grid(qtr ~ .) + 
  labs(title = "Distribution of Colorado Jail Size (by Population) in different
Quarters",
       y = "Count",
       x = "Jail Population")
```

The population per jail throughout Colorado is Unimodal, right-skewed distribution with significant outliers on the right of the
graph.

```{r List the Jails with the Largest Populations}
colorado_dist %>%
  filter(total > 20000) %>%
  distinct(county)
```

The largest jails in Colorado are the Adams, Arapahoe, and El Paso County Jails.

```{r Distribution Statistics}
total_summary <- colorado_dist %>%
  summarise(mean_total = mean(total),
    sd_total = sd(total),
    median_total = median(total),
    IQR_total = IQR(total))

total_summary
```

# 5. Linear Regression

In statistics, linear regression is a linear approach to modeling the relationship between a scalar response (or dependent variable) and one or more explanatory variables (or independent variables). 

One question we are trying to ask is to see which predictors are significant to whether a jail would on net release people during COVID-19. Let's fit a linear model about that.

```{r}
colorado_num_inmates <- colorado %>%
  filter(measure == "Number of inmates")

colorado_num_inmates %>%
  filter(county == "Pitkin" | county == "Pueblo")
```

Since only two jails (Pitkin and Pueblo) don't offer information on ethnicity or race for the measure of number of total inmates in only one of their quarters, this data, focused on ethnicity counts per county, is mostly complete for modelling. We'll remove these numbers

Let's focus on only quarter 1 and 3:

```{r}
colorado_num_inmates <- colorado %>%
  filter(measure == "Number of inmates") %>%
  filter(qtr == 1 | qtr == 3)
```

```{r}
colorado_num_inmates %>%
  count(county) %>%
  filter(n == 1)
```
Remove 4 jails that don't have both first and third quarter: Grand, Huerfano, Las Animas, Saguache

```{r}
selected_colorado_num_inmates <- colorado_num_inmates %>%
  filter(county != "Grand" & 
           county != "Huerfano" &
           county != "Las Animas" &
           county != "Saguache" & 
           county != "Jackson" & 
           county != "Routt") 

selected_colorado_num_inmates <- selected_colorado_num_inmates %>%
  select(-c(not_available, isNA, jms, qtr_year, measure, deaths, 
            other_gender, 
            bookings, releases)) %>%
  mutate(other_race = unknown_race + other_race) %>%
  select(-c(unknown_race)) %>%
  arrange(county)
```

Pivot_wider:

```{r}
selected_colorado_num_inmates <- selected_colorado_num_inmates %>% 
  pivot_wider(names_from = qtr, values_from = capacity:unknown_ethnicity) 
```

Standardize total, race, gender, ethnicity to percentages:

```{r}
selected_colorado_num_inmates <- selected_colorado_num_inmates %>%
  mutate(difference = (total_3 - total_1)/total_1) %>%
  mutate(male_percent = male_1 / total_1) %>%
  mutate(white_percent = white_1 / total_1) %>%
  mutate(black_percent = black_1 / total_1) %>%
  mutate(native_percent = native_american_1 / total_1) %>%
  mutate(other_race_percent = other_race_1 / total_1) %>%
  mutate(non_hispanic_percent = non_hispanic_1 / total_1) %>%
  mutate(hispanic_percent = hispanic_1 / total_1) %>%
  mutate(unknown_ethnicity_percent = unknown_ethnicity_1 / total_1) %>%
  select(county, difference:unknown_ethnicity_percent)
```

```{r include=FALSE}
full_model <- lm(difference ~ 
                    male_percent +
                    white_percent + 
                    black_percent + 
                    native_percent + 
                    other_race_percent + 
                    non_hispanic_percent + 
                    hispanic_percent + 
                    unknown_ethnicity_percent, 
                  data = selected_colorado_num_inmates)

int_only_model <- lm(difference ~ 1, data = selected_colorado_num_inmates)

covid_model <- step(full_model, scope = formula(int_only_model), direction = "backward")

```

Based on backwards AIC selection, we will use the model with white_percent, hispanic_percent.

```{r}
covid_model_aug <- augment(covid_model) %>%
  mutate(obs_num = row_number())
```

```{r}
resid_point <- ggplot(data = covid_model_aug, aes(x = .fitted, y = .resid)) +
  geom_point() +
  geom_hline(yintercept = 0, color = "Red") +
  labs(x = "Predicted",
  y = "Residual",
  title = "Residuals vs. Predicted")

resid_hist <- ggplot(data = covid_model_aug, aes(x = .resid)) +
  geom_histogram(bins = 10) +
  labs(x = "Residuals",
    y = "Count",
    title = "Distribution of Residuals")

resid_qq <- ggplot(data = covid_model_aug, aes(sample = .resid)) +
  stat_qq() +
  stat_qq_line() +
  labs(title = "Normal QQ-plot of residuals",
    y = "Sample",
    x = "Theoretical")

resid_point / (resid_hist + resid_qq)
```

Linearity, Constant Variance, Normality, and Independence are satisfied.

```{r}
resid_fitted <- ggplot(data = covid_model_aug, aes(x = .fitted, y = .std.resid)) +
  geom_point() +
  geom_hline(yintercept = 0, color = "red") +
  labs(x = "Predicted values",
  y = "Standard Residuals",
  title = "Check high leverage points") +
  geom_text(aes(label=ifelse(abs(.std.resid) > 2,
  as.character(obs_num), "")), nudge_x = 0) +
  geom_hline(yintercept =c(-2,2), color = "blue", lty = 2) +
  geom_hline(yintercept =c(-3,3), color = "red", lty = 2)

resid_fitted
```
Removed Jackson and Routt earlier b/c super small population totals/outliers resulted in skewed numbers and skewed model.

```{r}
covid_model %>%
  tidy %>%
  kable(digits = 3)
```

$$percent change-hat = 0.218 * white percent - 0.456 * hispanicpercent - 0.393$$

Interpretation: 

1. There is a positive relationship between the % of hispanic people in a jail and the jail increasing its net population. All else held constant, with every percentage increase in the amount of hispanic people in a jail, we expect there to be a 0.5% decrease in jail population from 2020 Q1 to Q3.	

2. There is a positive relationship between the percentage of white people in a jail and the jail increasing its net population. All else held constant, with every percentage increase in the amount of white people in a jail, we expect there to be a 0.2% increase in jail population from 2020 Q1 to Q3.	

# Future:

- Collect and add data on political leanings of counties (judiciary, national, county)

- ggmap() to create a spatial visualization to represent the counties that decreased the jail population counts the most

- Look at the race percentage changes themselves to see whether there are disparities in the people being released during COVID-19

- Look at gender

- Look at other predictor variables: beds, capacity, etc.

- Look at intake and outtake #'s themselves

- See which jails increased capacity and beds over time

- Analyze death counts possibly

# Comments: 

- This doesn't look at the "after" numbers for any of the predictor variables (race, gender, ethnicity). Another thing we can do in the future is analyze the difference between races over time.

- are the race variables independent enough? 

- try looking at which race percentage decreases the most

- look at bed increases or decreases

- look at capacity changes

- make helper functions to streamline the creation of other regression models

- ANova means to asess whether there's been a significant change due to COVID-19

- Look at Legalization, COVID-19, COVID-19 on Race

- How do I research whether having a larger percentage of Black people made jails more/less likely to release people?
